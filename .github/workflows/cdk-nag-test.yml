name: CDK Nag Test

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      id: run-tests
      continue-on-error: true
      run: npm test

    - name: Create GitHub Comment on Test Failure
      if: steps.run-tests.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');

          // テスト出力を読み取る
          const testOutput = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

          // エラーメッセージを抽出
          const errorMatches = testOutput.match(/\[error at .+?\] .+?(?=\n|$)/g);

          if (errorMatches) {
            const commentBody = `### CDK Nag Test Failures

            The CDK Nag test has identified the following issues that need to be addressed:

            ${errorMatches.map(error => `- ${error}`).join('\n')}

            Please review and update your infrastructure code to resolve these security and best practice warnings.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
          }

    - name: Fail if tests failed
      if: steps.run-tests.outcome == 'failure'
      run: exit 1
