name: CDK Nag Test

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      id: run-tests
      continue-on-error: true
      run: |
        npm test 2>&1 | tee test-output.log
        exit_code=${PIPESTATUS[0]}
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        exit $exit_code

    - name: Create GitHub Comment
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');

          // テスト出力を読み取る
          const testOutput = fs.readFileSync('test-output.log', 'utf8');

          // エラーメッセージを抽出
          const errorMatches = testOutput.match(/\[error at .+?\] .+?(?=\n|$)/g);

          let commentBody;
          if (errorMatches) {
            commentBody = `### CDK Nag Test Failures

            The CDK Nag test has identified the following issues that need to be addressed:

            ${errorMatches.map(error => `- ${error}`).join('\n')}

            Please review and update your infrastructure code to resolve these security and best practice warnings.`;
          } else {
                commentBody = `### CDK Nag Test Successful ✅

            All CDK Nag tests have passed successfully. No security or best practice warnings were found.`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

    - name: Fail if tests failed
      if: steps.run-tests.outputs.exit_code != 0
      run: exit 1
